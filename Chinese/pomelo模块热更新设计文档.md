#概述

对一款在线游戏来说, 在不停机的前提下更新一些游戏逻辑模块(如: 端午节活动模块, 排行榜模块等)是一个亟待解决的问题. Pomelo引擎当然也想为广大的游戏开发者提供代码热更新的方便接口. 
但是, 首先要说明的是: 并非所有的模块都可以都适合热更新. 例如一些被多个其它模块引用, 内部存储许多核心逻辑数据(如玩家关键数据)的模块就不太适合被热更新; 这样的模块一旦出了问题, 最好的解决方法是: 立刻发布游戏公告, 之后断开所有玩家的连接, 保存玩家在线数据, 修复bug, 重新开服, 向玩家发放必要的补偿安抚玩家情绪. 所以, Pomelo引擎对于代码热更新的支持仅限于这样的一些模块: 这些模块仅在一处被'require', 并且在游戏逻辑上是比较独立的存在, 与其它模块没有太多的耦合和交互, 一如上文所提到的'端午节活动', '排行榜'模块等.


##实现方法

需要热更新的模块需要实现为[Pomelo的plugin](https://github.com/NetEase/pomelo/wiki/plugin%E6%96%87%E6%A1%A3)形式.

Pomelo会提供一个专门用于管理可热更新模块及其数据的系统插件(pomelo-hotswapping-plugin), 这个系统插件会向外提供一些接口, 如: 1)以某个模块的名字为索引来存储/读取/修改/清理其所有数据; 2)热更新指定模块. 这样那些将会被热更新的模块与其所要使用的数据就做到了分离, 也就可以安全地来做热更新了. 在做代码热更新期间(清理V8引擎中的模块'cache', 重新'require'模块), 所有请求该模块的调用都将被丢弃, 这也是游戏开发者需要重点考虑的一点, 是否可以承受该模块短暂的拒绝服务. 所以, 可以进行热更新的模块还需要具备一些特征: 这些模块不能是那些玩家无时无刻都离开不了的极关键的模块, 而应该是那些玩家可以短暂离开的功能, 当完成热更新后立刻又能为玩家提供服务的模块.




##代码热更新的具体做法

做为一个在线游戏来说, GM Tools是一个必不可少的工具, 使用GM Tools来做代码热更新也是一个不错的选择. 在GM Tools中登录管理员帐号, 向游戏服务器发送GM指令, 在GM指令中指定要热更新模块的名称. 对Pomelo来说, 处理GM指令与处理其它游戏逻辑调用是一样的, 唯一一点不同就是, 这些对GM指令进行响应的'Handler'内部需要对GM的身份进行严格校验. 例如: 使用白名单功能对所有GM指令的使用者进行过滤等.
还有一个简便的方法: 在普通游戏客户端的聊天区发送特殊模式的聊天信息, 例如所有以'$'开头的聊天信息都被当做GM指令处理, 在这种GM指令中指定一些关键字来做模块热更新, 如'$ update rankList'等.


##GitHub链接地址

[pomelo模块热更新设计文档](https://github.com/palmtoy/pomelo-wiki/blob/master/Chinese/pomelo%E6%A8%A1%E5%9D%97%E7%83%AD%E6%9B%B4%E6%96%B0%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3.md)